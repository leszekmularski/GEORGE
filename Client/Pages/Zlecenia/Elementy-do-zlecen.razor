@page "/Elementy-do-zlecen/{RowIdZlecenia}/{typ}"
@using GEORGE.Shared.Models
@using GEORGE.Shared.ViewModels
@using GEORGE.Shared.Class
@using GEORGE.Client.Pages
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using AntDesign
@inject IMessageService _message
@inject PdfReaderService PdfReaderService
@inject GEORGE.Client.Pages.PDF.PdfDataParserElementy PdfDataParserElement
@inject Utilities.ILocalStorage LocalStorage
@using System.Net;
@using System.Text.Json;
@inject INotificationService _notice
@using AntDesign.TableModels
@using System.ComponentModel.DataAnnotations
@inject ModalService _modalService
@using System.Text.RegularExpressions
@inject IConfirmService _confirmService
@using ReservationBookingSystem.Services;
@using ClosedXML.Excel;

<!DOCTYPE html>
<html>
<head>
    <style>
        /* Styl dla linków */
        .custom-link {
        color: blue;
        }

        .custom-linkszy {
        color: darkblue;
        }

        /* Główna tabela z przewijaniem */
        .highlighted-background {
        background-color: white;
        overflow: auto; /* Dodaje paski przewijania, gdy zawartość przekracza rozmiar kontenera */
        max-height: calc(100vh - 55px); /* Maksymalna wysokość kontenera dopasowana do wysokości okna minus 55px */
        width: calc(100% - 260px); /* Ustawia szerokość na 100% okna minus 260px */
        box-sizing: border-box; /* Uwzględnia padding i border w obliczaniu rozmiarów */
        position: absolute;
        left: 260px; /* Ustawia lewą krawędź 260px od lewej strony okna */
        top: 55px; /* Ustawia górną krawędź 55px od góry okna */
        }

        /* Klasa "uwaga" z mocnym podświetleniem */
        .uwaga, .uwaga > td {
        background-color: #ff4d4d !important; /* Mocny czerwony */
        color: white !important; /* Biały tekst dla lepszej widoczności */
        font-weight: bold; /* Pogrubienie tekstu */
        border: 2px solid red; /* Czerwona ramka */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2); /* Delikatny cień dla głębi */
        transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Płynna zmiana koloru i cienia */
        }

        .uwaga:hover, .uwaga:hover > td {
        background-color: antiquewhite !important; /* Zmiana tła na jasnoróżowy przy najechaniu */
        color: black !important; /* Tekst zmienia się na czarny przy najechaniu */
        box-shadow: 0px 6px 8px rgba(0, 0, 0, 0.3); /* Większy cień przy najechaniu */
        font-size: 1.0em; /* Zachowanie wielkości czcionki */
        }

        /* Klasa "zamowiono" z wyrazistymi stylami */
        .zamowiono, .zamowiono > td {
        background-color: lightseagreen !important; /* Wyrazisty zielony */
        color: black !important; /* Czarny tekst dla kontrastu */
        font-weight: normal; /* Normalny tekst */
        border: 1px solid black; /* Czarna ramka */
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2); /* Delikatny cień dla głębi */
        transition: background-color 0.3s ease, box-shadow 0.3s ease; /* Płynna zmiana stylów */
        }

        .zamowiono:hover, .zamowiono:hover > td {
        background-color: mediumslateblue !important; /* Zmiana tła na fioletowy przy najechaniu */
        font-size: 1.0em; /* Zachowanie wielkości czcionki */
        }

        /* Klasa "zrealizowano" z zielonym podświetleniem */
        .zrealizowano, .zrealizowano > td {
        background-color: forestgreen !important; /* Mocny zielony dla zrealizowanych zamówień */
        color: white; /* Biały tekst dla lepszej widoczności */
        }

        .zrealizowano:hover, .zrealizowano:hover > td {
        background-color: mediumslateblue !important; /* Zmiana tła na fioletowy przy najechaniu */
        font-size: 1.0em; /* Zachowanie wielkości czcionki */
        }
    </style>

    <meta charset="utf-8" />

    <script>
        function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function () {
        console.log('Text copied to clipboard');
        }).catch(function (error) {
        console.error('Error copying text: ', error);
        });
        } else {
        // Fallback method
        var textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
        document.execCommand('copy');
        console.log('Text copied to clipboard');
        } catch (err) {
        console.error('Error copying text: ', err);
        }
        document.body.removeChild(textArea);
        }
        }

        function saveAsExcel(jsonData) {
        const data = JSON.parse(jsonData);
        const csvRows = [];

        // Extract headers
        const headers = Object.keys(data[0]);
        csvRows.push(headers.join(','));

        // Extract rows
        for (const row of data) {
        const values = headers.map(header => {
        const escaped = ('' + row[header]).replace(/"/g, '\\"');
        return `"${escaped}"`;
        });
        csvRows.push(values.join(','));
        }

        // Create CSV file
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'zamowienia_all.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        }

        function saveAsExcelSel(jsonData) {
        const data = JSON.parse(jsonData);
        const csvRows = [];

        // Zdefiniuj nagłówki - unikamy powtórzeń i zachowujemy kolejność zgodnie z C#
        const headers = ["NazwaProduktu", "NumerKatalogowy", "Typ", "IloscSztuk", "Kolor", "Dlugosc", "Szerokosc", "Wysokosc"];
        csvRows.push(headers.join(','));

        // Przetwarzaj dane
        for (const row of data) {
        const values = headers.map(header => {
        // Użyj klucza header do pobrania odpowiedniej wartości z każdego wiersza
        const value = row[header] || "";  // Używamy pustego stringa jeśli wartość jest null lub undefined
        // Ucieczka znaków podwójnych cudzysłowów i innych specjalnych znaków
        const escaped = ('' + value).replace(/"/g, '""');
        return `"${escaped}"`;  // Zwróć wartość otoczoną cudzysłowami
        });
        csvRows.push(values.join(','));
        }

        // Stworzenie pliku CSV
        const csvString = csvRows.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', 'elementyZamowienia.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        }

        
        window.saveAsExcelExcelPozycje = (base64Excel, fileName) => {
            const binary = atob(base64Excel);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }

            const blob = new Blob([bytes], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        };

        function saveAsTxtFile(textData, fileName) {
            const blob = new Blob([textData], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', fileName);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

    </script>

    <PageTitle>Zamówiona elementy do zlecenia</PageTitle>

</head>

<body>

    <Layout class="highlighted-background">
        <Header Style="height:50%;">
            <h6 style="color:yellow; padding-top:5px">Zamówione elementy do: @dotyczyZlecenia</h6>
            @if (boolAdmin || boolZmiana)
            {
                <Button Type="primary" OnClick="@(ShowDialogAddNew)">
                    Dodaj nową pozycję do zamówienia
                </Button>
            }

            @if (elementyDoZlecen != null && elementyDoZlecen.Count > 0)
            {
                <Tooltip Placement="@Placement.BottomCenter" Title="Wygeneruj zamówienie i wyslij pocztą elektroniczną.">
                    <Button Type="reset" Icon="@IconType.Fill.Mail" OnClick="@(OpenDefaultEmailApp)" />
                </Tooltip>
                <Tooltip Placement="@Placement.BottomCenter" Title="Wygeneruj zamówienie i wyslij pocztą elektroniczną (metoda SMPT z pominięciem programu pocztowego).">
                    <Button Type="reset" Icon="@IconType.Fill.Mail" OnClick="@(SendElementCheckToEmailViaSmtp)" />
                </Tooltip>
                <Tooltip Placement="@Placement.BottomCenter" Title="@uwagaKopiuj">
                    <Button Type="reset" Icon="@IconType.Fill.Copy" OnClick="@(CopyElementyToClipboard)" />
                </Tooltip>
                <Tooltip Placement="@Placement.BottomCenter" Title="Kopiuj zaznaczone dane do schowka. Te dane można wkleić w innym zleceniu.">
                    <Button Type="reset" Icon="@IconType.Fill.Copy" OnClick="@(CopyElementyChekToClipboard)" />
                </Tooltip>
                <Tooltip Placement="@Placement.Top" Title="Wklej skopiowane pozycje z innego zamówienia!">
                    <Button type="button" class="btn btn-sm btn-light" Icon="@IconType.Outline.PaperClip" OnClick="@(async ()=> { await PasteElementyFromClipboard(ConfirmButtons.YesNo); })"></Button>
                </Tooltip>
                <Button Type="reset" OnClick="@(ExportToExcel)">
                    Zapisz do pliku CSV - wszystko
                </Button>
                <Tooltip Placement="@Placement.BottomCenter" Title="Zapisz do pliku CSV - tylko wymagane">
                    <Button Type="reset" Icon="@IconType.Fill.FileExcel" OnClick="@(ExportSelectedColumnsToExcel)" />
                </Tooltip>
                <Button Type="reset" OnClick="@(ExportSelectedColumnsItemsToExcel)">
                    Zapisz do pliku CSV - zaznaczone
                </Button>
                <Tooltip Placement="@Placement.BottomCenter" Title="Zapisz sformatowany dokument EXCEL.">
                    <Button Type="reset" Icon="@IconType.Fill.FileExcel" OnClick="@(ZapiszExcelPozycjePoStronieKlienta)" />
                </Tooltip>
                <Tooltip Placement="@Placement.BottomCenter" Title="Zapisz sformatowany dokument EXCEL format VBH.">
                    <Button Type="reset" Icon="@IconType.Fill.FileExcel" OnClick="@(ZapiszExcelPozycjePoStronieKlientaVBH)" />
                </Tooltip>
                <Tooltip Placement="@Placement.BottomCenter" Title="Zaznaczone zapisz do pliku txt (format VBH)">
                    <Button Type="reset" Icon="@IconType.Fill.FileText" OnClick="@(ExportSelectedColumnsToVBH)" />
                </Tooltip>
                <Button OnClick="PrzelaczWidok">
                    @(pokazujTylkoNiezamowione ? "Pokaż wszystkie" : "Pokaż tylko niezamówione")
                </Button>

            }
            else
            {
                <Tooltip Placement="@Placement.Top" Title="Wklej skopiowane pozycje z innego zamówienia!">
                    <Button type="button" class="btn btn-sm btn-light" Icon="@IconType.Outline.PaperClip" OnClick="@(async ()=> { await PasteElementyFromClipboard(ConfirmButtons.YesNo); })"></Button>
                </Tooltip>
            }
            <Tooltip Placement="@Placement.BottomCenter" Style="width: 50px;" Title="Ilość widocznych rekordów">
                <AntDesign.InputNumber TValue="int"
                @bind-Value="_pageSize"
                Min="2"
                Max="25"
                Bordered="false"
                OnChange="@(e => OnClickChange(e))"
                Style="width: 100%; padding: 0; border-radius: 4px; color:navajowhite" />
            </Tooltip>

            <Tooltip Placement="@Placement.TopRight" Title="Wróć do poprzedniej strony">
                <Button class="btn-back" Icon="@IconType.Fill.Backward" OnClick="GoBack"></Button>
            </Tooltip>
            <label style="color:aqua; padding-left:8px">Zaznaczyłeś wierszy: @(_items == null ? 0 : _items.Count())</label>
        </Header>

        <Content Style="height:80%">

            @if (elementyDoZlecen == null)
            {
                <Spin Style="margin-left:47%" />
                <p style="margin-left:40%"><em>Czekaj na załadowanie danych...</em></p>
            }
            else
            {
                if (elementyDoZlecen != null && elementyDoZlecen.Count > 0 && _pageSize > 0)
                {
                    <Divider>Ilość pozycji do zamówienia: @elementyDoZlecen.Count(), suma sztuk: @elementyDoZlecen.Sum(x => x.ElemetZamDoZlecen.IloscSztuk).ToString()</Divider>

                    <Table TItem="ElemetZamDoZlecenWithProducent" DataSource="elementyDoZlecen" PageSize="@_pageSize"
                    Loading="_loading" ScrollX="2950" Size="TableSize.Small" RowKey="x => x?.ElemetZamDoZlecen?.Id"
                    @bind-SelectedRows="_items"
                    RowClassName="@(x =>
                            x?.Data?.ElemetZamDoZlecen?.Opis?.ToUpper().StartsWith("SPRAWDZ") == true ? "uwaga" :
                            (x?.Data?.ElemetZamDoZlecen?.CzyZamowiono == true ? (x?.Data?.ElemetZamDoZlecen?.DataDostarczenia > DateTime.MinValue ? "zrealizowano" :
                            "zamowiono") :
                            (x?.Data?.ElemetZamDoZlecen?.DataDostarczenia > DateTime.MinValue ? "zrealizowano" :
                            "move-class")))">
                        <ColumnDefinitions Context="context">
                            <Selection Width="25px" />
                            <PropertyColumn Title="ID" Property="c=>c.ElemetZamDoZlecen.Id" Hidden />
                            <PropertyColumn Width="250" Title="Nazwa Producenta" Property="c=>c.ProducentIMiejscowosc" Sortable OnFilter="(a, b) => a == b" Filterable />
                            <PropertyColumn Title="Nazwa Produktu" Width="280" Property="c=>c.ElemetZamDoZlecen.NazwaProduktu" Sortable Filterable></PropertyColumn>@* DefaultSortOrder="SortDirection.Ascending" *@
                            <PropertyColumn Width="250" Title="Numer Katalogowy" Property="c=>c.ElemetZamDoZlecen.NumerKatalogowy" Sortable Filterable />
                            <PropertyColumn Width="160" Title="Kolor" Property="c=>c.ElemetZamDoZlecen.Kolor" Sortable />
                            <PropertyColumn Width="160" Title="Typ" Property="c=>c.ElemetZamDoZlecen.Typ" Sortable />
                            <PropertyColumn Width="60" Title="Jednostka" Property="c=>c.ElemetZamDoZlecen.Jednostka" />
                            <PropertyColumn Title="Ilość" Width="50px" Property="c=>c.ElemetZamDoZlecen.IloscSztuk" />
                            <PropertyColumn Width="95" Title="Data Zamówienia" Property="c=>c.ElemetZamDoZlecen.DataZamowienia" Format="yyyy-MM-dd" />
                            <Column Title="Czy zam." TData="ElemetZamDoZlecenWithProducent">
                                <Template>
                                    <Checkbox @bind-Checked="@context.ElemetZamDoZlecen.CzyZamowiono" OnChange="(e)=>Handle(e, context.ElemetZamDoZlecen.Id)" Disabled="isNotDisabled" />
                                </Template>
                            </Column>
                            <Column Title="Poz. dost." TData="ElemetZamDoZlecenWithProducent">
                                <Template>
                                    <Checkbox @bind-Checked="@context.ElemetZamDoZlecen.PozDostarczono" OnChange="(e)=>HandleDost(e, context.ElemetZamDoZlecen.Id, context.ElemetZamDoZlecen.RowIdZlecenia, context.ElemetZamDoZlecen.RowIdProducent)" Disabled="isNotDisabled" />
                                </Template>
                            </Column>

                            <PropertyColumn Width="160" Title="Opis" Property="c=>c.ElemetZamDoZlecen.Opis" />

                            <PropertyColumn Title="Szerokość" Property="c=>c.ElemetZamDoZlecen.Szerokosc" />
                            <PropertyColumn Title="Wysokość" Property="c=>c.ElemetZamDoZlecen.Wysokosc" />
                            <PropertyColumn Title="Długość" Property="c=>c.ElemetZamDoZlecen.Dlugosc" />
                            <PropertyColumn Title="Objętość" Property="c=>c.ElemetZamDoZlecen.Objetosc" />
                            <PropertyColumn Title="Uwagi" Width="460" Property="c=>c.ElemetZamDoZlecen.Uwagi" />
                            <PropertyColumn Width="195" Title="Autor zmian" Property="c=>c.ElemetZamDoZlecen.KtoZapisal" />

                            <!-- Przykład kolumny dla daty z formatowaniem -->
                            <PropertyColumn Width="95" Title="Data Zapisu" Property="c=>c.ElemetZamDoZlecen.DataZapisu" Format="yyyy-MM-dd HH:mm:ss" />
                            <!-- Przykład kolumny z niestandardowym renderowaniem komórki -->
                            <ActionColumn Title="Akcja" Width="100" Fixed="right">
                                @if (boolAdmin || boolZmiana)
                                {
                                    <Popconfirm Placement="@Placement.Left" Title="Czy chcesz edytować pozycję?"
                                    OnConfirm="()=> editRow(context.ElemetZamDoZlecen.Id)"
                                    OkText="Tak"
                                    CancelText="Nie">
                                        <a>Edytuj</a>
                                    </Popconfirm>
                                }
                                @if (boolAdmin || boolUsuniecia)
                                {
                                    <Popconfirm Placement="@Placement.Left" Title="Czy chcesz usunąć pozycję?"
                                    OnConfirm="()=> deleteRow(context.ElemetZamDoZlecen.Id)"
                                    OkText="Tak"
                                    CancelText="Nie">
                                        <a style="color:red">Usuń</a>
                                    </Popconfirm>
                                }
                            </ActionColumn>
                        </ColumnDefinitions>
                    </Table>
                }
                else
                {
                    <h2>Do tego zlecenia (oferty) nie zamówiono żadnych elementów</h2>
                }
            }
        </Content>

        <Footer>
            <div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="fileInput" style="font-size:0.7em; font-weight:bold;">
                        Wybierz plik ze Stolcad z listą materiałów (C:\STOLCAD\Rob\PrnPdf - zestawienie elementów):
                    </label>
                    <InputFile id="fileInput" OnChange="HandleFileSelected" />

                    <Button Type="@ButtonType.Link" style="font-size:1.0em; height:30px; margin-top:0; font-style:revert-layer; color:brown" @onclick="() => PasteStolcad()">
                        Wklej ze schowka elementyZamowienia z STOLCAD [ODWOŁANIA]
                    </Button>
                    <Checkbox @bind-Checked="isCheckedDelAll">Usuń wszystkie dane przed zapisem nowych</Checkbox>
                </div>


                @if (zestawienie != null)
                {
                    <div>
                        <Divider></Divider>
                        <Button Type="@ButtonType.Primary" Style="width:99%" Disabled="@isNotDisabled" OnClick="SaveAll">Zapisz wyszystkie zapisane z poniższej tabeli</Button>
                    </div>

                    <div style="overflow: auto; width: 100%; height: 200px">

                        <h4>Zestawienie Nr: @zestawienie.NrZestawienia</h4>
                        <p>Data: @zestawienie.Data.ToString("yyyy/MM/dd")</p>
                        <p>Odbiorca: @zestawienie.Odbiorca</p>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Lp</th>
                                    <th>Szerokość</th>
                                    <th>Wysokość</th>
                                    <th>Ilość</th>
                                    <th>Nazwa Produktu</th>
                                    <th>Numer Katalogowy</th>
                                    <th>Powierchnia</th>
                                    <th>Uwagi</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in zestawienie.ListaElementow)
                                {
                                    <tr>
                                        <td>@item.Lp</td>
                                        <td>@item.Szerokosc</td>
                                        <td>@item.Wysokosc</td>
                                        <td>@item.IloscSztuk</td>
                                        <td>@item.NazwaProduktu</td>
                                        <td>@item.NumerKatalogowy</td>
                                        <td>@item.Powierzchnia</td>
                                        <td>@item.Uwagi</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </Footer>

    </Layout>

    <div class="modal fade @classShow" tabindex="-1" style="display: @display;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Poz. do zamówienia dodaj / zmień</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" @onclick="HandleCancel">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @if (elementyDoZlecen != null && elementyZamowienia.ElemetZamDoZlecen != null)
                    {
                        <NowaPozZamowienia elementyZamowienia="elementyZamowienia" elementyDoZlecen="elementyDoZlecen" OnButtonClicked="CloseModal" user="user" />
                    }
                    else
                    {
                        <h4>Czekaj na załadowanie formatki!!!</h4>
                    }
                </div>
            </div>
        </div>
    </div>

</body>
</html>

@code {
    [Parameter]
    public string? RowIdZlecenia { get; set; }

    [Parameter]
    public string? typ { get; set; }

    [Inject] private AppState AppState { get; set; } = default!;

    private string? pdfContent;

    private List<ElemetZamDoZlecenWithProducent>? elementyDoZlecen;
    private List<ElemetZamDoZlecenWithProducent>? oryginalElementyDoZlecen;

    List<ElemetZamDoZlecenWithProducent> mockDb = new();

    private GEORGE.Client.Pages.PDF.ZestawienieElementZamowienia? zestawienie;

    private bool _visible = false;
    private string display = "none;";
    private string classShow = "";

    private long cid = -1;

    private ElemetZamDoZlecenWithProducent elementyZamowienia = new ElemetZamDoZlecenWithProducent();

    private List<ElemetZamDoZlecenWithProducent>? zamowieniaall;

    private string uwagaKopiuj = "Kopiuj do schowka dane";

    private bool isCheckedDelAll = false;

    int _pageSize = 7;

    private string dotyczyZlecenia = "";
    private string dotyczyKlienta = "";

    bool _loading = false;

    IEnumerable<ElemetZamDoZlecenWithProducent>? _items;

    protected override async Task OnInitializedAsync()
    {
        _pageSize = Convert.ToInt32((await LocalStorage.GetStringAsync("elementy_ile_widocznych")));
        if (_pageSize == 0) _pageSize = 6;

        await Laduj_Uprawnienia();

        elementyZamowienia = new ElemetZamDoZlecenWithProducent
                {
                    ElemetZamDoZlecen = new ElemetZamDoZlecen
                    {
                        Id = 0,
                        RowIdZlecenia = RowIdZlecenia,
                        DataZamowienia = DateTime.MinValue,
                        DataRealizacji = DateTime.MinValue,
                        DataZapisu = DateTime.Now,
                        KtoZapisal = "Autor zmiany: " + user
                    },
                    ProducenciPodwykonawcy = new ProducenciPodwykonawcy
                    {
                // Przypisz odpowiednie wartości dla właściwości ProducenciPodwykonawcy
                        NazwaProducenta = "" // Przykładowa wartość
                    },
                    DodatkowaInformacja = "Dane z dnia" + DateTime.Now
                };

        if (AppState != null)
        {
            AppState.SomeData = "";
        }

        if (string.IsNullOrWhiteSpace(RowIdZlecenia))
        {
            Console.WriteLine($"Bład: brak danych w RowIdZlecenia");
        }
        else
        {
            Console.WriteLine($"RowIdZlecenia: {RowIdZlecenia}");
        }

        _loading = true;

        try
        {
            elementyDoZlecen = await Http.GetFromJsonAsync<List<ElemetZamDoZlecenWithProducent>>($"api/ElementyDoZlecen/rowid/{RowIdZlecenia}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"******* Błąd {ex.Message}");
            await _message.Error("Błąd ładowania danych");
        }

        try
        {
            if (typ == "zew")
            {
                var response = await Http.GetAsync($"api/ZlecenieProdukt/getzlecclickzew/{RowIdZlecenia}");


                if (response.IsSuccessStatusCode)
                {
                    var zleceniaProdukcyjne = await response.Content.ReadFromJsonAsync<List<ZleceniaProdukcyjne>>();

                    if (zleceniaProdukcyjne != null && zleceniaProdukcyjne.Count > 0)
                    {
                        dotyczyZlecenia = $"{zleceniaProdukcyjne[0].TypZamowienia} / {zleceniaProdukcyjne[0].NumerZamowienia} / {zleceniaProdukcyjne[0].Klient}";
                        dotyczyKlienta = zleceniaProdukcyjne[0].Klient ?? "";
                    }
                }
            }
            else if (typ == "wew")
            {
                var response = await Http.GetAsync($"api/ZlecenieProdukt/getzlecclickwew/{RowIdZlecenia}");

                if (response.IsSuccessStatusCode)
                {
                    var zleceniaProdukcyjne = await response.Content.ReadFromJsonAsync<List<ZleceniaProdukcyjneWew>>();

                    if (zleceniaProdukcyjne != null && zleceniaProdukcyjne.Count > 0)
                    {
                        dotyczyZlecenia = $"{zleceniaProdukcyjne[0].TypZamowienia ?? ""} / {zleceniaProdukcyjne[0].NumerZamowienia ?? ""} / {zleceniaProdukcyjne[0].Klient ?? ""}";
                        dotyczyKlienta = zleceniaProdukcyjne[0].Klient ?? "";
                    }
                }
            }

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd pobierania zleceń produkcyjnych: {ex.Message}");
        }

        _loading = false;
    }

    // void OnChangeSel(QueryModel<ElemetZamDoZlecenWithProducent> query)
    // {
    //     _iloscZaznaczonych = mockDb.AsQueryable().ExecuteTableQuery(query).Count();
    //     var _dataSourceTest = mockDb.AsQueryable().ExecuteTableQuery(query).CurrentPagedRecords(query).ToList();
    //     Console.WriteLine($"Zaznaczyłeś ilość wierszy: {_iloscZaznaczonych}");
    // }


    public async Task ExportToExcel()
    {
        if (elementyDoZlecen != null)
        {
            var jsonData = JsonSerializer.Serialize(elementyDoZlecen);
            await JSRuntime.InvokeVoidAsync("saveAsExcel", jsonData);
        }
    }

    private async Task ZapiszExcelPozycjePoStronieKlienta()
    {

        if (_items == null || !_items.Any())
        {
            await _message.Warning("Brak zaznaczonych pozycji do zapisania.");
            return;
        }

        var dane = _items.Select(k => new
        {
            NazwaProduktu = RemoveWhitespace(k.ElemetZamDoZlecen.NazwaProduktu),
            NumerKatalogowy = RemoveWhitespace(k.ElemetZamDoZlecen.NumerKatalogowy),
            Typ = RemoveWhitespace(k.ElemetZamDoZlecen.Typ),
            IloscSztuk = k.ElemetZamDoZlecen.IloscSztuk,
            Jednostka = k.ElemetZamDoZlecen.Jednostka,
            Kolor = k.ElemetZamDoZlecen.Kolor,
            Dlugosc = k.ElemetZamDoZlecen.Dlugosc,
            Szerokosc = k.ElemetZamDoZlecen.Szerokosc,
            Wysokosc = k.ElemetZamDoZlecen.Wysokosc,
        }).ToList();

        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Elementy");

        // Nagłówki
        var headers = new[]
        {
            "Nazwa produktu", "Numer katalogowy", "Typ", "Ilość sztuk", "Jednostka",
            "Kolor", "Długość", "Szerokość", "Wysokość"
        };

        for (int col = 0; col < headers.Length; col++)
        {
            var cell = worksheet.Cell(1, col + 1);
            cell.Value = headers[col];
            cell.Style.Font.Bold = true;
            cell.Style.Font.FontSize = 14;
            cell.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightGray;
            cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
            cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
            cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
        }

        int row = 2;
        foreach (var item in dane)
        {
            worksheet.Cell(row, 1).Value = item.NazwaProduktu;
            worksheet.Cell(row, 2).Value = item.NumerKatalogowy;
            worksheet.Cell(row, 3).Value = item.Typ;
            worksheet.Cell(row, 4).Value = item.IloscSztuk;
            worksheet.Cell(row, 5).Value = item.Jednostka;
            worksheet.Cell(row, 6).Value = item.Kolor;
            worksheet.Cell(row, 7).Value = item.Dlugosc;
            worksheet.Cell(row, 8).Value = item.Szerokosc;
            worksheet.Cell(row, 9).Value = item.Wysokosc;

            for (int col = 1; col <= 9; col++)
            {
                var cell = worksheet.Cell(row, col);
                cell.Style.Font.FontSize = 12;
                cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Left;
                cell.Style.Alignment.Vertical = ClosedXML.Excel.XLAlignmentVerticalValues.Center;
            }

            row++;
        }

        worksheet.Columns().AdjustToContents();

        await using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        stream.Position = 0;

        var base64 = Convert.ToBase64String(stream.ToArray());

        string nazwaKlienta = Regex.Replace(dotyczyKlienta ?? "klient", $"[{Regex.Escape(new string(Path.GetInvalidFileNameChars()))}]", "_");
        string fileName = $"Zamowienie_{nazwaKlienta}.xlsx";

        await JSRuntime.InvokeVoidAsync("saveAsExcelExcelPozycje", base64, fileName);
        await _message.Success("Plik Excel został pobrany.");
    }

    private async Task ZapiszExcelPozycjePoStronieKlientaVBH()
    {

        if (_items == null || !_items.Any())
        {
            await _message.Warning("Brak zaznaczonych pozycji do zapisania.");
            return;
        }
        //"Zapas", "Symbol", "Kolor", "Ilość", "Nazwa", "Typ", "Jednostka", "Uwagi"

        var dane = _items.Select(k => new
        {
            NazwaProduktu = RemoveWhitespace(k.ElemetZamDoZlecen.NazwaProduktu),
            NumerKatalogowy = RemoveWhitespace(k.ElemetZamDoZlecen.NumerKatalogowy),
            Typ = RemoveWhitespace(k.ElemetZamDoZlecen.Typ),
            IloscSztuk = k.ElemetZamDoZlecen.IloscSztuk,
            Jednostka = k.ElemetZamDoZlecen.Jednostka,
            Kolor = k.ElemetZamDoZlecen.Kolor,
            Dlugosc = k.ElemetZamDoZlecen.Dlugosc,
            Szerokosc = k.ElemetZamDoZlecen.Szerokosc,
            Wysokosc = k.ElemetZamDoZlecen.Wysokosc,
            Uwagi = k.ElemetZamDoZlecen.Uwagi,
        }).ToList();

        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Elementy");

        // Nagłówki
        var headers = new[]
        {
            "Zapas", "Symbol", "Kolor", "Ilość", "Nazwa", "Typ", "Jednostka", "Uwagi"
        };

        for (int col = 0; col < headers.Length; col++)
        {
            var cell = worksheet.Cell(1, col + 1);
            cell.Value = headers[col];
            cell.Style.Font.Bold = true;
            cell.Style.Font.FontSize = 14;
            cell.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightGray;
            cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
            cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
            cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
        }

        int row = 2;
        foreach (var item in dane)
        {
            worksheet.Cell(row, 1).Value = "Zapas";
            worksheet.Cell(row, 2).Value = item.NumerKatalogowy;
            worksheet.Cell(row, 3).Value = item.Kolor;
            worksheet.Cell(row, 4).Value = item.IloscSztuk;
            worksheet.Cell(row, 5).Value = item.NazwaProduktu;
            worksheet.Cell(row, 6).Value = item.Typ;
            worksheet.Cell(row, 7).Value = item.Jednostka;
            worksheet.Cell(row, 8).Value = item.Uwagi;

            for (int col = 1; col <= headers.Length; col++)
            {
                var cell = worksheet.Cell(row, col);
                cell.Style.Font.FontSize = 12;
                cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Left;
                cell.Style.Alignment.Vertical = ClosedXML.Excel.XLAlignmentVerticalValues.Center;
            }

            row++;
        }

        worksheet.Columns().AdjustToContents();

        await using var stream = new MemoryStream();
        workbook.SaveAs(stream);
        stream.Position = 0;

        var base64 = Convert.ToBase64String(stream.ToArray());

        string nazwaKlienta = Regex.Replace(dotyczyKlienta ?? "klient", $"[{Regex.Escape(new string(Path.GetInvalidFileNameChars()))}]", "_");
        string fileName = $"Zamowienie_{nazwaKlienta}.xlsx";

        await JSRuntime.InvokeVoidAsync("saveAsExcelExcelPozycje", base64, fileName);
        await _message.Success("Plik Excel został pobrany.");
    }

    public async Task ExportSelectedColumnsItemsToExcel()
    {
        // Sprawdzenie, czy są zaznaczone elementy
        if (_items != null && _items.Any())
        {
            var selectedData = _items.Select(k => new
            {
                NazwaProduktu = RemoveWhitespace(k.ElemetZamDoZlecen.NazwaProduktu),
                NumerKatalogowy = RemoveWhitespace(k.ElemetZamDoZlecen.NumerKatalogowy),
                Typ = RemoveWhitespace(k.ElemetZamDoZlecen.Typ),
                IloscSztuk = k.ElemetZamDoZlecen.IloscSztuk,
                Jednostka = k.ElemetZamDoZlecen.Jednostka,
                Kolor = k.ElemetZamDoZlecen.Kolor,
                Dlugosc = k.ElemetZamDoZlecen.Dlugosc,
                Szerokosc = k.ElemetZamDoZlecen.Szerokosc,
                Wysokosc = k.ElemetZamDoZlecen.Wysokosc,
            });

            var jsonData = JsonSerializer.Serialize(selectedData);
            await JSRuntime.InvokeVoidAsync("saveAsExcelSel", jsonData);
        }
        else
        {
            // Można dodać komunikat dla użytkownika, że nie wybrano żadnych elementów
            Console.WriteLine("Brak zaznaczonych elementów do eksportu.");
        }
    }


    public async Task ExportSelectedColumnsToExcel()
    {
        if (elementyDoZlecen != null)
        {
            var selectedData = elementyDoZlecen.Select(k => new
            {
                NazwaProduktu = RemoveWhitespace(k.ElemetZamDoZlecen.NazwaProduktu),
                NumerKatalogowy = RemoveWhitespace(k.ElemetZamDoZlecen.NumerKatalogowy),
                Typ = RemoveWhitespace(k.ElemetZamDoZlecen.Typ),
                IloscSztuk = k.ElemetZamDoZlecen.IloscSztuk,
                Jednostka = k.ElemetZamDoZlecen.Jednostka,
                Kolor = k.ElemetZamDoZlecen.Kolor,
                Dlugosc = k.ElemetZamDoZlecen.Dlugosc,
                Szerokosc = k.ElemetZamDoZlecen.Szerokosc,
                Wysokosc = k.ElemetZamDoZlecen.Wysokosc,
            });

            var jsonData = JsonSerializer.Serialize(selectedData);
            await JSRuntime.InvokeVoidAsync("saveAsExcelSel", jsonData);
        }
    }

    public async Task ExportSelectedColumnsToVBH()
    {
        if (_items == null || !_items.Any())
        {
            await _message.Warning("Nie wybrano żadnych pozycji do eksportu!");
            return;
        }

        // Projekcja danych
        var selectedData = _items.Select(k => new
        {
            Symbol = RemoveWhitespace(k.ElemetZamDoZlecen?.NumerKatalogowy ?? string.Empty),
            Kolor = string.IsNullOrWhiteSpace(k.ElemetZamDoZlecen?.Kolor) ? "Brak" : k.ElemetZamDoZlecen.Kolor,
            Ilosc = k.ElemetZamDoZlecen?.IloscSztuk ?? 0,
            Opis = RemoveWhitespace(k.ElemetZamDoZlecen?.NazwaProduktu ?? string.Empty),
            Zakladka = "ZAKLADKA",
            Cena = "----",
            Grupa = "",
            Waluta = "",
            JM = string.IsNullOrWhiteSpace(k.ElemetZamDoZlecen?.Jednostka) ? "szt." : k.ElemetZamDoZlecen.Jednostka,
            Opakowanie = ""
        }).ToList();

        // Nagłówek VBH
        var header =
            "Zamówienie VBH Polska Sp.z o.o.\n" +
            "PPHU \"GEORGE\"\n" +
            "7341136804\n" +
            "PPHU \"GEORGE\" Marcinkowice 351, 33-393 Marcinkowice\n" +
            $"Data {DateTime.Now:yyyy/MM/dd} {DateTime.Now:HH:mm}\n" +
            "PPHU \"GEORGE\"\n" +
            string.Format(
                "{0,-20}{1,-15}{2,-7}{3,-41}{4,-11}{5,-13}{6,-11}{7,-8}{8,-11}{9,-12}\n",
                "Symbol", "Kolor", "Ilosc", "Opis", "Zakładka", "Cena w wal", "Grupa rab", "Waluta", "JM", "OPAKOWANIE"
            );

        // Funkcja pomocnicza — ucinanie / padding
        static string PadOrTruncate(string value, int width, bool alignRight = false)
        {
            if (string.IsNullOrEmpty(value)) value = string.Empty;
            if (value.Length > width)
                return value.Substring(0, width);
            return alignRight ? value.PadLeft(width) : value.PadRight(width);
        }

        // Linie danych — szerokości identyczne jak nagłówek
        var lines = selectedData.Select(k =>
            string.Format(
                "{0,-20}{1,-15}{2,7} {3,-41}{4,-11}{5,-13}{6,-11}{7,-8}{8,-11}{9,-12}",
                PadOrTruncate(k.Symbol, 20),
                PadOrTruncate(k.Kolor, 15),
                k.Ilosc, // liczby wyrównane do prawej
                PadOrTruncate(k.Opis, 41),
                PadOrTruncate(k.Zakladka, 11),
                PadOrTruncate(k.Cena, 13),
                PadOrTruncate(k.Grupa, 11),
                PadOrTruncate(k.Waluta, 8),
                PadOrTruncate(k.JM, 11),
                PadOrTruncate(k.Opakowanie, 12)
            )
        );

        var fullText = header + string.Join("\n", lines);

        // Nazwa pliku — usuń znaki specjalne
        var fileName = string.IsNullOrEmpty(dotyczyKlienta)
            ? $"Zamowienie_{DateTime.Now:yyyyMMdd_HHmm}"
            : RemoveSpecChar(dotyczyKlienta);

        await JSRuntime.InvokeVoidAsync("saveAsTxtFile", fullText, $"{fileName}.txt");
    }


    private string RemoveSpecChar(string fileName)
    {
        if (string.IsNullOrWhiteSpace(fileName))
            return "plik";

        // Niedozwolone znaki w nazwach plików Windows
        var invalidChars = Path.GetInvalidFileNameChars();

        foreach (var c in invalidChars)
        {
            fileName = fileName.Replace(c, '_'); // zamieniamy na _
        }

        return fileName;
    }

    private string RemoveWhitespace(string input)
    {
        if (string.IsNullOrEmpty(input)) return input;

        // Usuwamy tabulatory i podwójne spacje
        return System.Text.RegularExpressions.Regex.Replace(input, @"\s+", " ").Trim();
    }

    private async Task OpenDefaultEmailApp()
    {
        if (_items != null && _items.Any())
        {
            var emailSubject = Uri.EscapeDataString("Zamówienie z firmy GEORGE z dnia: " + DateTime.Now.ToShortDateString());
            var emailBody = Uri.EscapeDataString(
            $"<html>Dotyczy: { dotyczyZlecenia}\n" +
            "Nazwa Produktu\tNumer Katalogowy\tTyp\tIlość\tJednostka\tKolor\n" +
                "--------------\t-----------------\t-----\t---------\t--------\n" +
                string.Join("\n", _items.Select(k =>
                    $"{k.ElemetZamDoZlecen.NazwaProduktu}\t" +
                    $"{k.ElemetZamDoZlecen.NumerKatalogowy}\t" +
                    $"{k.ElemetZamDoZlecen.Typ}\t" +
                    $"{k.ElemetZamDoZlecen.IloscSztuk}\t" +
                $"{k.ElemetZamDoZlecen.Jednostka}\t" +
                    $"{k.ElemetZamDoZlecen.Kolor}"
            )) + "\n\n\n" + $"Zamówienie wygenerował {Uimie} {Unazwisko} System produkcyjny PPHU GEORGE Marcinkowice 351, 33-393 Marcinkowice tel:(+48 18) 44-33-111</html>"
            );

            var mailtoLink = $"mailto:?subject={emailSubject}&body={emailBody}";
            await JSRuntime.InvokeVoidAsync("window.open", mailtoLink);
        }
        else
        {
            await _message.Warning("Brak danych do wysłania.");
        }
    }

    bool czekajNaWysWiad = false;
    private async Task SendElementCheckToEmailViaSmtp()
    {
        if (string.IsNullOrEmpty(adresEmail) || string.IsNullOrEmpty(hasloPoczta))
        {
            await _message.Info("Nie masz poprawnie skonfigurowanego adresu e-mail.", 5);
            return;
        }

        if (czekajNaWysWiad) return;

        if (_items != null && _items.Any())
        {
            await _message.Info("Czekaj na wysłanie wiadomości.", 1);
            czekajNaWysWiad = true;

            var emailSubject = "Zamówienie z firmy GEORGE z dnia: " + DateTime.Now.ToShortDateString();

            // Generowanie HTML
            var builder = new System.Text.StringBuilder();
            builder.AppendLine("<html><body>");
            builder.AppendLine($"<h2>Zamówienie z firmy GEORGE Dotyczy: {dotyczyZlecenia}</h2>");
            builder.AppendLine("<table border='1' style='border-collapse: collapse; width: 100%; text-align: left;'>");
            builder.AppendLine("<thead><tr><th>Nazwa Produktu</th><th>Numer Katalogowy</th><th>Typ</th><th>Ilość</th><th>Jednostka</th><th>Kolor</th></tr></thead>");
            builder.AppendLine("<tbody>");
            foreach (var k in _items)
            {
                builder.AppendLine($"<tr><td>{k.ElemetZamDoZlecen.NazwaProduktu}</td><td>{k.ElemetZamDoZlecen.NumerKatalogowy}</td><td>{k.ElemetZamDoZlecen.Typ}</td><td>{k.ElemetZamDoZlecen.IloscSztuk}</td><td>{k.ElemetZamDoZlecen.Jednostka}</td><td>{k.ElemetZamDoZlecen.Kolor}</td></tr>");
            }
            builder.AppendLine("</tbody></table>");
            builder.AppendLine($"<h4>Zamówienie wygenerował {Uimie} {Unazwisko}</h4>");
            builder.AppendLine("</body></html>");

            var emailBody = builder.ToString();

            // 📄 GENERUJEMY EXCELA
            using var workbook = new ClosedXML.Excel.XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Zamówienie");

            // Nagłówki
            var headerRow = worksheet.Row(1);
            worksheet.Cell(1, 1).Value = "Nazwa Produktu";
            worksheet.Cell(1, 2).Value = "Numer Katalogowy";
            worksheet.Cell(1, 3).Value = "Typ";
            worksheet.Cell(1, 4).Value = "Ilość";
            worksheet.Cell(1, 5).Value = "Jednostka";
            worksheet.Cell(1, 6).Value = "Kolor";

            // Styl nagłówków
            for (int col = 1; col <= 6; col++)
            {
                var cell = worksheet.Cell(1, col);
                cell.Style.Font.Bold = true;
                cell.Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightGray;
                cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
            }

            int row = 2;
            foreach (var k in _items)
            {
                worksheet.Cell(row, 1).Value = k.ElemetZamDoZlecen.NazwaProduktu;
                worksheet.Cell(row, 2).Value = k.ElemetZamDoZlecen.NumerKatalogowy;
                worksheet.Cell(row, 3).Value = k.ElemetZamDoZlecen.Typ;
                worksheet.Cell(row, 4).Value = k.ElemetZamDoZlecen.IloscSztuk;
                worksheet.Cell(row, 5).Value = k.ElemetZamDoZlecen.Jednostka;
                worksheet.Cell(row, 6).Value = k.ElemetZamDoZlecen.Kolor;

                for (int col = 1; col <= 6; col++)
                {
                    var cell = worksheet.Cell(row, col);
                    cell.Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                    cell.Style.Border.InsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
                    cell.Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Left;
                    cell.Style.Alignment.Vertical = ClosedXML.Excel.XLAlignmentVerticalValues.Center;
                }

                row++;
            }

            // Auto-dopasowanie kolumn
            worksheet.Columns().AdjustToContents();

            await using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            stream.Position = 0;

            // Usuń niedozwolone znaki z nazwy pliku
            string nazwaPliku = string.Concat(dotyczyKlienta.Split(Path.GetInvalidFileNameChars()));

            // 📤 Wysyłka multipart/form-data
            var formContent = new MultipartFormDataContent
            {
            { new StringContent(adresEmail), "ToEmail" },
            { new StringContent(hasloPoczta), "Password" },
            { new StringContent(emailSubject), "Subject" },
            { new StringContent(emailBody), "HtmlBody" },
            { new StreamContent(stream), "Attachment", $"Zamowienie_{nazwaPliku}.xlsx" }
            };

            try
            {
                var response = await Http.PostAsync("api/mail/sendwithattachment", formContent);

                if (response.IsSuccessStatusCode)
                {
                    await _message.Success("Wiadomość z załącznikiem została wysłana.");
                }
                else
                {
                    Console.WriteLine($"Kod odpowiedzi: {(int)response.StatusCode} ({response.StatusCode})");

                    var error = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Błąd: {error}");
                    await _message.Error($"Błąd: {error}");
                }
            }
            catch (Exception ex)
            {
                await _message.Error($"Błąd podczas wysyłania wiadomości: {ex.Message}");
            }
        }
        else
        {
            await _message.Warning("Brak danych do wysłania.");
        }

        czekajNaWysWiad = false;
    }

    private async Task CopyElementyToClipboard()
    {
        if (elementyDoZlecen == null || elementyDoZlecen.Count == 0) return;

        var kantowkiText = string.Join("\n", elementyDoZlecen.Select(k =>
        $"RowIdZlecenia: {k.ElemetZamDoZlecen.RowIdZlecenia}, Szrokość: {k.ElemetZamDoZlecen.Szerokosc}, Wysokość: {k.ElemetZamDoZlecen.Wysokosc}, Nazwa Produktu: {k.ElemetZamDoZlecen.NazwaProduktu}, Numer Katalogowy: {k.ElemetZamDoZlecen.NumerKatalogowy}, Ilość: {k.ElemetZamDoZlecen.IloscSztuk}, Uwagi: {k.ElemetZamDoZlecen.Uwagi}, DataZamowienia: {k.ElemetZamDoZlecen.DataZamowienia}, DataRealizacji: {k.ElemetZamDoZlecen.DataRealizacji}, DataZapisu: {k.ElemetZamDoZlecen.DataZapisu}, KtoZapisal: {k.ElemetZamDoZlecen.KtoZapisal}, OstatniaZmiana: {k.ElemetZamDoZlecen.OstatniaZmiana}"
    ));

        await JSRuntime.InvokeVoidAsync("copyToClipboard", kantowkiText);

        uwagaKopiuj = "Dane skopiowano do schowka";

        await _message.Success("Dane skopiowano do schowka");
    }

    // Dodaj tę zmienną w klasie (np. jako pole klasy)
    private bool pokazujTylkoNiezamowione = false;

    // Funkcja toggle'ująca widok
    private async Task PrzelaczWidok()
    {
        pokazujTylkoNiezamowione = !pokazujTylkoNiezamowione;

        await OdswiezListeElementow();
    }

    // Funkcja do filtrowania danych w zależności od stanu
    private async Task OdswiezListeElementow()
    {
        if (elementyDoZlecen == null || elementyDoZlecen.Count == 0) return;

        if (pokazujTylkoNiezamowione)
        {
            elementyDoZlecen = elementyDoZlecen
            .Where(k => k.ElemetZamDoZlecen?.CzyZamowiono == false)
            .ToList();
        }
        else
        {
            _loading = true;
            elementyDoZlecen = await Http.GetFromJsonAsync<List<ElemetZamDoZlecenWithProducent>>($"api/ElementyDoZlecen/rowid/{RowIdZlecenia}");
            _loading = false;
        }

        StateHasChanged(); // tylko jeśli potrzebne

    }

    private async Task CopyElementyChekToClipboard()
    {
        // Sprawdzenie, czy są zaznaczone elementy
        if (_items != null && _items.Any())
        {
            var selectedData = string.Join("\n", _items.Select(k => new
            {
                RowIdProducent = RemoveWhitespace(k.ElemetZamDoZlecen.RowIdProducent),
                NazwaProduktu = RemoveWhitespace(k.ElemetZamDoZlecen.NazwaProduktu),
                NumerKatalogowy = RemoveWhitespace(k.ElemetZamDoZlecen.NumerKatalogowy),
                Typ = RemoveWhitespace(k.ElemetZamDoZlecen.Typ),
                IloscSztuk = k.ElemetZamDoZlecen.IloscSztuk,
                Jednostka = k.ElemetZamDoZlecen.Jednostka,
                Kolor = k.ElemetZamDoZlecen.Kolor,
                Dlugosc = k.ElemetZamDoZlecen.Dlugosc,
                Szerokosc = k.ElemetZamDoZlecen.Szerokosc,
                Wysokosc = k.ElemetZamDoZlecen.Wysokosc,
            }));

            await JSRuntime.InvokeVoidAsync("copyToClipboard", selectedData);

            uwagaKopiuj = "Dane skopiowano do schowka";

            await _message.Success("Zaznaczone dane skopiowano do schowka");
        }
        else
        {
            // Można dodać komunikat dla użytkownika, że nie wybrano żadnych elementów
            Console.WriteLine("Brak zaznaczonych elementów do eksportu.");
            await _message.Info("Brak zaznaczonych elementów do eksportu.");
        }
    }

    private async Task PasteElementyFromClipboard(ConfirmButtons confirmButtons)
    {
        // Treść komunikatu i tytuł
        var content = "Czy wkleić skopiowane pozycje z innego zamówienia?";
        var title = "Uwaga!!!";

        // Wyświetlenie komunikatu potwierdzającego
        var confirmResult = await _confirmService.Show(content, title, confirmButtons);

        // Sprawdzenie wyniku potwierdzenia

        if (confirmResult == ConfirmResult.No)
        {
            return;
        }
        // Pobranie danych ze schowka
        var daneZeSchowka = await JSRuntime.InvokeAsync<string>("navigator.clipboard.readText");

        daneZeSchowka = daneZeSchowka.Trim();

        if (!daneZeSchowka.StartsWith("{") || !daneZeSchowka.EndsWith("}") || !daneZeSchowka.Contains("RowIdProducent"))
        {
            await _message.Info("Niepoprawny format danych!!!");
            return;
        }

        // Parsowanie tekstu do listy obiektów ElemetZamDoZlecen
        var elementyDoZlecenC = new List<ElemetZamDoZlecen>();

        // Regex do dopasowania właściwości w wierszu
        var regex = new Regex(@"\s*(\w+)\s*=\s*(.*?)(?:,|$)");

        // Iteracja po każdej linii
        foreach (var linia in daneZeSchowka.Split('\n', StringSplitOptions.RemoveEmptyEntries))
        {
            var element = new ElemetZamDoZlecen();

            foreach (Match match in regex.Matches(linia))
            {
                string key = match.Groups[1].Value.Trim();
                string value = match.Groups[2].Value.Trim().Trim('\"');

                // Przypisanie wartości do odpowiednich właściwości
                switch (key)
                {
                    case "RowIdProducent":
                        element.RowIdProducent = value;
                        break;
                    case "NazwaProduktu":
                        element.NazwaProduktu = value;
                        break;
                    case "NumerKatalogowy":
                        element.NumerKatalogowy = value;
                        break;
                    case "Typ":
                        element.Typ = value;
                        break;
                    case "IloscSztuk":
                        element.IloscSztuk = float.TryParse(value, out var ilosc) ? ilosc : 0;
                        break;
                    case "Jednostka":
                        element.Jednostka = value;
                        break;
                    case "Kolor":
                        element.Kolor = value;
                        break;
                    case "Dlugosc":
                        element.Dlugosc = decimal.TryParse(value, out var dlugosc) ? dlugosc : 0;
                        break;
                    case "Szerokosc":
                        element.Szerokosc = decimal.TryParse(value, out var szerokosc) ? szerokosc : 0;
                        break;
                    case "Wysokosc":
                        element.Wysokosc = decimal.TryParse(value, out var wysokosc) ? wysokosc : 0;
                        break;
                }
            }

            element.RowIdZlecenia = RowIdZlecenia;

            element.KtoZapisal = "Autor zmiany (CTRL+V): " + user;

            elementyDoZlecenC.Add(element);

        }

        // Wysłanie danych za pomocą HttpClient
        using var httpClient = new HttpClient();

        try
        {
            // var response = await httpClient.PostAsJsonAsync($"api/ElementyDoZlecen", elementyDoZlecenC);
            var response = await Http.PostAsJsonAsync($"api/elementyDoZlecen/save-all/{false}", elementyDoZlecenC);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Dane zostały pomyślnie zapisane.");
                elementyDoZlecen = await Http.GetFromJsonAsync<List<ElemetZamDoZlecenWithProducent>>($"api/ElementyDoZlecen/rowid/{RowIdZlecenia}");
                if (elementyDoZlecen != null) oryginalElementyDoZlecen = elementyDoZlecen.DeepCopyList();
                await _message.Success($"Dane zostały pomyślnie zapisane. ilość nowych wpisów: {elementyDoZlecenC.Count()}" , 1);
            }
            else
            {
                Console.WriteLine($"Błąd podczas zapisywania danych: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Wystąpił błąd: {ex.Message}");
            await _message.Error($"Wystąpił błąd: {ex.Message}");
        }

    }

    private async void Handle(bool value, long idr)
    {
        Console.WriteLine($"{value} / {idr}");
        await ZapiszUstawienieStanuCzyZam(idr, value);

    }

    private async Task ZapiszUstawienieStanuCzyZam(long idr, bool nowyStan)
    {
        //  var aktualizacja = new { Id = idr, MaterialZeStanMagazyn = nowyStan };

        var response = await Http.PutAsJsonAsync($"api/ElementyDoZlecen/{idr}/updateCzyZamowiono", nowyStan);

        if (response.IsSuccessStatusCode)
        {
            if (elementyDoZlecen != null)
            {
                var element = elementyDoZlecen.FirstOrDefault(e => e.ElemetZamDoZlecen.Id == idr);

                if (element != null)
                {
                    element.ElemetZamDoZlecen.DataZamowienia = DateTime.Now;
                    oryginalElementyDoZlecen = elementyDoZlecen.DeepCopyList();
                    await _message.Success("Zmieniono status");
                    StateHasChanged();
                }

            }
        }
        else
        {
            await _message.Error("Nie zmieniono status");
        }
    }

    private async void HandleDost(bool value, long idr, string rowIdZlec, string rowIdProducent)
    {
        Console.WriteLine($"{value} / {idr}");
        await ZapiszUstawienieStanuCzyCzyDostarczono(idr, rowIdZlec, rowIdProducent, value);
    }

    bool pytanieOK = false;

    private async Task ZapiszUstawienieStanuCzyCzyDostarczono(long idr, string rowIdZlec, string rowIdProducent, bool nowyStan)
    {
        // Aktualizacja stanu dostarczenia w API
        var response = await Http.PutAsJsonAsync($"api/ElementyDoZlecen/{idr}/updateCzyDostarczono", nowyStan);

        if (response.IsSuccessStatusCode)
        {
            var podmiot = await Http.GetFromJsonAsync<List<ProducenciPodwykonawcy>>($"api/ProducenciPodwykonawcy/rowidpodmiot/{rowIdProducent}");

            if (podmiot != null && podmiot.Count() > 0)
            {
                var rodzDzial = podmiot[0].RodzajProdukcjiWykonywanej;

                if (!string.IsNullOrEmpty(rodzDzial))
                {
                    if (rodzDzial == "Producent szyb")
                    {
                        // Otwórz modal i poczekaj na odpowiedź
                        await OpenModal("Uwaga", "Czy potwierdzić status w zamówieniach szyb");

                        if (pytanieOK)
                        {
                            var responseszyby = await Http.PutAsJsonAsync($"api/szybyDoZlecen/{rowIdZlec}/updateDostarczonoPoRowId", nowyStan);
                            if (responseszyby.IsSuccessStatusCode)
                            {
                                await _message.Success("Status w danych Szyby zmieniono", 1);
                            }
                            else
                            {
                                await _message.Error("Status Szyby nie zmieniono");
                            }
                        }
                    }
                    else if (rodzDzial == "Producent kantówki")
                    {
                        // Otwórz modal i poczekaj na odpowiedź
                        await OpenModal("Uwaga", "Czy potwierdzić status w zamówieniach kantówki");

                        if (pytanieOK)
                        {
                            var responsekantowka = await Http.PutAsJsonAsync($"api/KantowkaDoZlecen/{rowIdZlec}/updateDateRealizacji", nowyStan);
                            if (responsekantowka.IsSuccessStatusCode)
                            {
                                await _message.Success("Status w danych Kantówki zmieniono", 1);
                            }
                            else
                            {
                                await _message.Error("Status Kantówki nie zmieniono");
                            }
                        }
                    }
                }
            }

            // Aktualizacja stanu dostarczenia w liście elementów
            if (elementyDoZlecen != null)
            {
                var element = elementyDoZlecen.FirstOrDefault(e => e.ElemetZamDoZlecen.Id == idr);
                if (element != null)
                {
                    element.ElemetZamDoZlecen.DataDostarczenia = DateTime.Now;
                    oryginalElementyDoZlecen = elementyDoZlecen.DeepCopyList();
                    await _message.Success("Zmieniono status");
                    StateHasChanged();
                }
            }
        }
        else
        {
            await _message.Error("Nie zmieniono statusu");
        }
    }

    private async Task OpenModal(string _title, string _contentText)
    {
        var modalCompletionSource = new TaskCompletionSource<bool>();

        RenderFragment content = @<div>@_contentText</div>;

        var options = new ConfirmOptions()
            {
                Title = _title,
                Width = 350,
                Content = content,
                OkText = "Tak",
                CancelText = "Nie",
                OnOk = async e =>
                {
                    Console.WriteLine("OnOk");
                    pytanieOK = true;
                    modalCompletionSource.SetResult(true);
                    await Task.CompletedTask;
                },
                OnCancel = async e =>
                {
                    Console.WriteLine("OnCancel");
                    pytanieOK = false;
                    modalCompletionSource.SetResult(false);
                    await Task.CompletedTask;
                }
            };

        var confirmRef = await _modalService.CreateConfirmAsync(options);

        confirmRef.OnOpen = () =>
        {
            Console.WriteLine("Open Modal");
            return Task.CompletedTask;
        };

        confirmRef.OnClose = () =>
        {
            Console.WriteLine("Close Modal");
            return Task.CompletedTask;
        };

        // Czekaj na zakończenie działania modalu
        await modalCompletionSource.Task;
    }


    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var path = Path.GetTempFileName();
            await using (var stream = file.OpenReadStream())
            await using (var fileStream = new FileStream(path, FileMode.Create))
            {
                await stream.CopyToAsync(fileStream);
            }

            pdfContent = PdfReaderService.ReadPdfTable(path);

            zestawienie = PdfDataParserElement.ParsePdfDataElementy(pdfContent);

            StateHasChanged();

        }
    }

    private async Task PasteStolcad()
    {
        try
        {
            // Pobranie danych ze schowka
            var clipboardText = await JSRuntime.InvokeAsync<string>("navigator.clipboard.readText");

            zestawienie = PdfDataParserElement.ParseClipboardData(clipboardText);

            StateHasChanged();

        }
        catch (Exception ex)
        {
            _ = _notice.Error(new()
                {
                    Message = ex.Message,
                    Description = ex.StackTrace,
                    Placement = NotificationPlacement.BottomLeft
                });
        }
    }


    private async Task SaveAll()
    {
        zamowieniaall = new List<ElemetZamDoZlecenWithProducent>();

        if (zestawienie == null) return;
        @foreach (var item in zestawienie.ListaElementow)
        {
            decimal numSzerokosc;

            if (decimal.TryParse(item.Szerokosc, out numSzerokosc))
            {
                var elementyZamowienia = new ElemetZamDoZlecenWithProducent
                    {
                        ElemetZamDoZlecen = new ElemetZamDoZlecen
                        {
                            RowIdZlecenia = RowIdZlecenia,
                            Szerokosc = string.IsNullOrEmpty(item.Szerokosc) ? 0 : numSzerokosc,
                            Wysokosc = string.IsNullOrEmpty(item.Wysokosc) ? 0 : decimal.Parse(item.Wysokosc),
                            NazwaProduktu = item.NazwaProduktu,
                            IloscSztuk = string.IsNullOrEmpty(item.IloscSztuk) ? 0 : int.Parse(item.IloscSztuk),
                            DataZamowienia = DateTime.Now,
                            DataRealizacji = DateTime.Now.AddDays(14),
                            DataZapisu = DateTime.Now,
                            KtoZapisal = "Autor zmiany: " + user
                        },
                        DodatkowaInformacja = "Dane zaimportowano z PDF" // Zamiast Uwagi
                    };

                zamowieniaall.Add(elementyZamowienia);
            }
        }


        try
        {
            // Wyślij dane do API
            var response = await Http.PostAsJsonAsync($"api/elementyDoZlecen/save-all/{isCheckedDelAll}", zamowieniaall);

            if (response.IsSuccessStatusCode)
            {
                // Operacja zakończona sukcesem
                Console.WriteLine("Dane zostały zapisane pomyślnie.");

                elementyDoZlecen = await Http.GetFromJsonAsync<List<ElemetZamDoZlecenWithProducent>>($"api/ElementyDoZlecen/rowid/{RowIdZlecenia}");

                zestawienie = null;
            }
            else
            {
                // Obsłuż błąd
                Console.WriteLine("Wystąpił błąd podczas zapisywania danych.");
            }
        }
        catch (Exception ex)
        {
            // Obsłuż wyjątek
            Console.WriteLine($"Wystąpił błąd: {ex.Message}");
        }
    }

    private async Task HandleSubmit()
    {

        if (_visible == false) return;

        _visible = false;

        await HideDialog();

        StateHasChanged(); // Odśwież widok

    }

    public async Task deleteRow(long id)
    {
        if (elementyDoZlecen == null) return;

        try
        {
            var response = await Http.DeleteAsync($"api/ElementyDoZlecen/{id}");

            if (response.IsSuccessStatusCode)
            {
                // Usunięcie rekordu z listy po pomyślnym usunięciu z serwera
                elementyDoZlecen = elementyDoZlecen.Where(r => r.ElemetZamDoZlecen.Id != id).ToList();
                Console.WriteLine("Rekord został pomyślnie usunięty.");
            }
            else
            {
                Console.WriteLine($"Błąd podczas usuwania rekordu: {response.ReasonPhrase}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"******* Błąd {ex.Message}");
        }
    }

    public async Task editRow(long id)
    {
        //listOfData = listOfData.Where(d => d.Id != id).ToArray();
        if (elementyDoZlecen == null) return;

        oryginalElementyDoZlecen = elementyDoZlecen.DeepCopyList();

        // Logika edycji
        if (_visible)
        {
            _visible = false;
            await HideDialog();
        }
        else
        {
            elementyZamowienia = new ElemetZamDoZlecenWithProducent();

            var listOfData = elementyDoZlecen.Where(d => d.ElemetZamDoZlecen.Id == id).ToArray();

            // Pobierz elementyZamowienia na podstawie indeksu wiersza
            if (listOfData != null && listOfData.Count() > 0)
            {
                cid = id;

                elementyZamowienia = listOfData[0];

                _visible = true;

                await ShowDialog();
            }

            // Wyświetl numer zamówienia w konsoli
            Console.WriteLine(elementyZamowienia.ElemetZamDoZlecen.NazwaProduktu);
        }

    }

    private async Task CloseModal()
    {
        Console.WriteLine("CloseModal");

        pokazujTylkoNiezamowione = false;

        await HandleCancel();

        if (elementyDoZlecen != null) oryginalElementyDoZlecen = elementyDoZlecen.DeepCopyList();

        elementyDoZlecen = await Http.GetFromJsonAsync<List<ElemetZamDoZlecenWithProducent>>($"api/ElementyDoZlecen/rowid/{RowIdZlecenia}");
    }

    public async Task HandleCancel()
    {
        _visible = false;
        await HideDialog();
    }

    public async Task HandleCloseAdd()
    {
        _visible = false;
        await HideDialog();
        await HandleSubmit();
    }

    public async Task ShowDialogAddNew()
    {
        var version = System.Reflection.Assembly.GetExecutingAssembly().GetName().Version;
        string zapisZWersji = "";
        if (version != null)
        {
            zapisZWersji = " / Zapisano z wersji: " + version.ToString();
        }

        elementyZamowienia = new ElemetZamDoZlecenWithProducent
            {
                ElemetZamDoZlecen = new ElemetZamDoZlecen
                {
                    Id = 0,
                    RowIdZlecenia = RowIdZlecenia,
                    DataZamowienia = DateTime.MinValue,
                    DataRealizacji = DateTime.MinValue,
                    DataZapisu = DateTime.Now,
                    KtoZapisal = "Autor zmiany: " + user
                },
                ProducenciPodwykonawcy = new ProducenciPodwykonawcy
                {
                    // Przypisz odpowiednie wartości dla właściwości ProducenciPodwykonawcy
                    NazwaProducenta = "" // Przykładowa wartość
                },
                DodatkowaInformacja = "Dane z dnia" + DateTime.Now + zapisZWersji
            };

        cid = -1;

        display = "block";
        classShow = "show";
        StateHasChanged();

        await Task.CompletedTask;
    }

    public async Task ShowDialog()
    {
        display = "block";
        await Task.Delay(50);
        classShow = "show";
        StateHasChanged();
    }

    private async Task HideDialog()
    {
        if (cid > 0 && elementyDoZlecen != null)
        {
            elementyDoZlecen = oryginalElementyDoZlecen;
        }

        cid = -1;

        classShow = "";
        await Task.Delay(200);
        display = "none";

        StateHasChanged();
    }

    private async Task GoBack()
    {
        await JSRuntime.InvokeVoidAsync("history.back");
    }

    private async Task OnClickChange(int e)
    {
        Console.WriteLine("Zapisano ilość widocznych" + e);
        await LocalStorage.SaveStringAsync("elementy_ile_widocznych", e.ToString());
    }

    private bool boolOdczyt = false;
    private bool boolZmiana = false;
    private bool boolUsuniecia = false;
    private bool boolAdmin = false;
    private string RowIdPracownika = "";
    private string? user;
    private string? adresEmail = "";
    private string? hasloPoczta = "";
    private string? Uimie = "";
    private string? Unazwisko = "";
    private bool isNotDisabled => !boolZmiana || !boolAdmin;
    private List<UprawnieniaPracownikaViewModel>? uprawnienia;

    private async Task Laduj_Uprawnienia()
    {
        user = await LocalStorage.GetStringAsync("user");

        if (string.IsNullOrEmpty(user))
        {
            //NavigationManager.NavigateTo($"", true);
            user = "NaN";
            return;
        }

        string nazwaTabeli = "ElemetZamDoZlecen";

        Console.WriteLine($"api/ZwrocSatus/{user}/{nazwaTabeli}");

        try
        {
            uprawnienia = await Http.GetFromJsonAsync<List<UprawnieniaPracownikaViewModel>>($"/api/ZwrocSatus/{user}/{nazwaTabeli}");
        }
        catch (System.Net.Http.HttpRequestException ex) when (ex.StatusCode == HttpStatusCode.NotFound)
        {
            Console.WriteLine("Brak danych!!!");
            await _message.Error("Brak danych - status użytkownika");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            await _message.Error(ex.Message);
        }

        if (uprawnienia != null)
        {
            if (uprawnienia.Count > 0)
            {
                var znalezioneElementy = uprawnienia.Where(uprawnienie => uprawnienie.TableName == nazwaTabeli);
                Console.WriteLine("Znaleziono uprawnienia dla użytkownika: " + user + " w tabeli: " + nazwaTabeli + " ilość rekordów: " + znalezioneElementy.Count());
                if (znalezioneElementy.Any())
                {
                    var szuk = znalezioneElementy.FirstOrDefault(x => x.TableName == nazwaTabeli);
                    if (szuk != null)
                    {
                        boolOdczyt = szuk.Odczyt;
                        boolZmiana = szuk.Zmiana;
                        boolUsuniecia = szuk.Usuniecie;
                        boolAdmin = szuk.Administrator;
                        RowIdPracownika = szuk.RowId;
                        adresEmail = szuk.Email;
                        hasloPoczta = szuk.HasloDoPoczty;
                        Uimie = szuk.Imie;
                        Unazwisko = szuk.Nazwisko;
                    }
                }
            }
        }
    }
}
